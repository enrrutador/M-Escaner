<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Productos con Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="app-container">
        <!-- Página principal (Escáner) -->
        <div id="scanner-page" class="page">
            <div class="header">
                <button id="search-button" class="blue-button">Buscar</button>
                <button id="scan-button" class="red-button">Escáner</button>
                <div class="menu-container">
                    <button id="menu-button" class="blue-button">Menú</button>
                    <ul class="menu-list">
                        <li><a href="#productos">Productos</a></li>
                        <li><a href="#stock-Mínimo">Stock mínimo</a></li>
                        <li><a href="#dash">Dash</a></li>
                        <li><button id="import-button" class="menu-button">Importar</button></li>
                        <li><button id="export-button" class="menu-button">Exportar</button></li>
                    </ul>
                </div>
            </div>

            <form id="product-form">
                <label for="product-name">Nombre del Producto:</label>
                <input type="text" id="product-name" class="editable" />

                <label for="barcode">Código de Barras:</label>
                <input type="text" id="barcode" class="editable" />

                <div class="price-container">
                    <div class="price-item">
                        <label for="purchase-price">Precio de Compra:</label>
                        <input type="number" id="purchase-price" class="editable" />
                    </div>
                    <div class="price-item">
                        <label for="sale-price">Precio de Venta:</label>
                        <input type="number" id="sale-price" class="editable" />
                    </div>
                </div>

                <div class="stock-container">
                    <div class="stock-item">
                        <label for="stock">Stock:</label>
                        <input type="number" id="stock" class="editable" />
                    </div>
                    <div class="stock-item">
                        <label for="minimum-stock">Stock Mínimo:</label>
                        <input type="number" id="minimum-stock" class="editable" />
                    </div>
                </div>

                <div class="button-container">
                    <button type="submit" id="save-button">Guardar</button>
                    <button type="button" id="clear-button">Borrar</button>
                </div>
            </form>

            <!-- Scanner overlay -->
            <div id="scanner-overlay">
                <div id="scanner-container"></div>
            </div>
        </div>

        <!-- Página de Productos -->
        <div id="productos-page" class="page" style="display:none;">
            <h1>Productos</h1>
            <div id="productos-list">
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Código de Barras</th>
                            <th>Precio de Compra</th>
                            <th>Precio de Venta</th>
                            <th>Stock</th>
                            <th>Stock Mínimo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los productos se añadirán dinámicamente aquí -->
                    </tbody>
                </table>
            </div>
            <button class="back-button">Volver al Escáner</button>
        </div>

        <!-- Página de Stock Mínimo -->
        <div id="stock-Mínimo-page" class="page" style="display:none;">
            <h1>Stock Mínimo</h1>
            <div id="stock-bajo-list"></div>
            <button class="back-button">Volver al Escáner</button>
        </div>

        <!-- Página de Dash con Dashboard dinámico -->
        <div id="dash-page" class="page" style="display:none;">
            <h1>Dashboard</h1>

            <!-- Selector para elegir el gráfico -->
            <select id="chartSelector" onchange="updateChart()">
                <option value="top10MaxStock">Top 10 productos con más stock</option>
                <option value="top10MinStock">Top 10 productos con menor stock</option>
                <option value="lowStockPie">Proporción de Productos con Bajo Stock</option>
                <option value="stockComparisonPie">Porcentaje de productos en stock normal vs. bajo stock</option>
                <option value="replenishmentBar">Productos que necesitan reabastecimiento</option>
                <option value="valuableStockBar">Stock de productos valiosos vs. productos menos valiosos</option>
                <option value="priceComparisonBar">Comparación de precios de compra y venta</option>
            </select>

            <div id="dashboard-container">
                <canvas id="stockChart"></canvas>
            </div>

            <button class="back-button" onclick="showPage('scanner-page')">Volver al Escáner</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <input type="file" id="file-input" accept=".xlsx, .xls" style="display:none;">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="script.js"></script>

    <script>
        // Función para mostrar las páginas
        function showPage(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        // Función para actualizar el gráfico basado en el selector
        function updateChart() {
            const chartType = document.getElementById('chartSelector').value;
            generateDashboard(chartType);  // Llama a la función de generación de gráficos con el tipo seleccionado
        }

        // Generar el Dashboard usando la API de Google Gemini
        async function generateDashboard(chartType) {
            const localData = JSON.parse(localStorage.getItem('products')) || [];

            try {
                const response = await fetch('https://gemini.googleapis.com/v1/data/analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer AIzaSyAHiraXVYzOh3QbAFOOSnMVNwZMwtXmdVE'  // Clave API
                    },
                    body: JSON.stringify({ data: localData })
                });

                if (!response.ok) {
                    throw new Error(`Error en la API: ${response.statusText}`);
                }

                const geminiData = await response.json();
                displayCharts(geminiData, chartType);  // Pasa el tipo de gráfico a la función
            } catch (error) {
                console.error('Error al comunicarse con la API de Google Gemini:', error);
                alert('Hubo un error al cargar los datos del Dashboard.');
            }
        }

        // Mostrar gráficos usando Chart.js basado en la selección del usuario
        function displayCharts(data, chartType) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            let productNames, productData;

            switch (chartType) {
                case 'top10MaxStock':
                    productNames = data.map(product => product.name);
                    productData = data.map(product => product.stock);
                    break;
                case 'top10MinStock':
                    productNames = data.map(product => product.name);
                    productData = data.map(product => product.stock);  // Ajustar lógica para top 10 mínimo
                    break;
                case 'lowStockPie':
                    productNames = ['Bajo Stock', 'Stock Normal'];
                    productData = [data.filter(p => p.stock < p.minimumStock).length, data.filter(p => p.stock >= p.minimumStock).length];
                    break;
                case 'stockComparisonPie':
                    productNames = ['Por debajo del mínimo', 'Stock normal'];
                    productData = [data.filter(p => p.stock < p.minimumStock).length, data.filter(p => p.stock >= p.minimumStock).length];
                    break;
                case 'replenishmentBar':
                    productNames = data.filter(p => p.stock < p.minimumStock).map(p => p.name);
                    productData = data.filter(p => p.stock < p.minimumStock).map(p => p.stock);
                    break;
                case 'valuableStockBar':
                    productNames = data.sort((a, b) => b.salePrice - a.salePrice).map(p => p.name);
                    productData = data.map(p => p.salePrice);
                    break;
                case 'priceComparisonBar':
                    productNames = data.map(p => p.name);
                    productData = data.map(p => p.purchasePrice);  // Cambiar para comparar compra y venta
                    break;
            }

            new Chart(ctx, {
                type: chartType.includes('Pie') ? 'pie' : 'bar',
                data: {
                    labels: productNames,
                    datasets: [{
                        label: 'Datos del Producto',
                        data: productData,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Cargar el Dashboard al acceder a la página
        document.addEventListener('DOMContentLoaded', function() {
            showPage('dash-page');  // Muestra la página del Dashboard para pruebas
            updateChart();  // Genera el Dashboard con el gráfico seleccionado
        });
    </script>
</body>
</html>
